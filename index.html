<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Mini Hoop Shot Detector</title>
  <style>
    :root{ --bg:#0b0e13; --ink:#e8eefc; --muted:#9fb0d5; --accent:#70e1ff; --ok:#45f0a0; }
    body{margin:0; background:var(--bg); color:var(--ink); font-family:sans-serif}
    .video-area{ position:relative; max-width:800px; margin:0 auto; }
    video{ width:100%; height:auto; display:block; background:#000 }
    canvas.overlay{ position:absolute; inset:0; width:100%; height:100%; pointer-events:auto; touch-action:none; background:transparent }
    .controls{display:flex; flex-wrap:wrap; gap:8px; justify-content:center; margin:12px}
    button{padding:8px 12px; border:none; border-radius:6px; cursor:pointer; font-weight:600}
    button.primary{background:#2b7cff; color:#fff}
    button.danger{background:#ff4d6d; color:#fff}
    .toast{position:fixed; left:50%; top:16px; transform:translateX(-50%) translateY(-20px); opacity:0; background:#10161f; padding:10px 16px; border-radius:8px; font-weight:700; transition:all .3s ease; z-index:10}
    .toast.show{transform:translateX(-50%) translateY(0); opacity:1}
    .magnifier{position:absolute; width:120px; height:120px; border:2px solid var(--accent); border-radius:50%; overflow:hidden; display:none; pointer-events:none; z-index:20}
    .magnifier canvas{width:100%; height:100%}
  </style>
</head>
<body>
  <div class="video-area">
    <video id="video" playsinline muted></video>
    <canvas class="overlay" id="overlay"></canvas>
    <div class="magnifier" id="magnifier"><canvas id="magCanvas"></canvas></div>
  </div>
  <div class="controls">
    <button id="btnStart" class="primary">Start camera</button>
    <button id="btnCalib">Calibrate</button>
    <button id="btnEdit">Edit line</button>
    <button id="btnDetect">Start detection</button>
    <button id="btnStop" class="danger">Stop</button>
  </div>
  <div class="toast" id="toast">Nice shot! üèÄ</div>

<script>
const els={video:document.getElementById('video'),overlay:document.getElementById('overlay'),btnStart:document.getElementById('btnStart'),btnCalib:document.getElementById('btnCalib'),btnEdit:document.getElementById('btnEdit'),btnDetect:document.getElementById('btnDetect'),btnStop:document.getElementById('btnStop'),toast:document.getElementById('toast'),magnifier:document.getElementById('magnifier'),magCanvas:document.getElementById('magCanvas')};
const octx=els.overlay.getContext('2d');
let stream=null,anim=null,running=false,detecting=false,editing=false;
let rimLine=null,history=[];
const work=document.createElement('canvas');
const wctx=work.getContext('2d',{willReadFrequently:true});
const SCALE=0.45,THRESH=28,MIN_AREA=120,MAX_AREA=2000;

function showToast(){els.toast.classList.add('show');setTimeout(()=>els.toast.classList.remove('show'),1200)}
function speak(t){try{let u=new SpeechSynthesisUtterance(t);speechSynthesis.cancel();speechSynthesis.speak(u);}catch(e){}}

async function startCam(){stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:{ideal:'environment'}},audio:false});els.video.srcObject=stream;await els.video.play();syncSize();running=true;detecting=false;loop();}
function stopAll(){detecting=false;running=false;if(anim)cancelAnimationFrame(anim);if(stream){stream.getTracks().forEach(t=>t.stop());stream=null;}}
function syncSize(){els.overlay.width=els.video.videoWidth||640;els.overlay.height=els.video.videoHeight||480;work.width=Math.round(els.overlay.width*SCALE);work.height=Math.round(els.overlay.height*SCALE);}

function draw(){octx.clearRect(0,0,els.overlay.width,els.overlay.height);if(rimLine){drawLine(rimLine.x1,rimLine.y1,rimLine.x2,rimLine.y2);drawGate();if(editing){drawHandle(rimLine.x1,rimLine.y1);drawHandle(rimLine.x2,rimLine.y2)}}}
function drawLine(x1,y1,x2,y2){octx.save();octx.strokeStyle='#70e1ff';octx.lineWidth=3;octx.setLineDash([6,6]);octx.beginPath();octx.moveTo(x1,y1);octx.lineTo(x2,y2);octx.stroke();octx.restore()}
function drawHandle(x,y){octx.beginPath();octx.arc(x,y,10,0,Math.PI*2);octx.fillStyle='#70e1ff';octx.fill()}
function gateRect(){const {x1,y1,x2,y2}=rimLine;const wlen=Math.hypot(x2-x1,y2-y1);const ux=(x2-x1)/wlen,uy=(y2-y1)/wlen;const nx=uy,ny=-ux; // flip so gate extends downward
const gh=100,halfW=wlen*0.45;const cx=(x1+x2)/2,cy=(y1+y2)/2;const topCx=cx,topCy=cy;return{ux,uy,nx,ny,gh,halfW,topCx,topCy}};
function drawGate(){const g=gateRect();const ax=g.topCx-g.ux*g.halfW,ay=g.topCy-g.uy*g.halfW;const bx=g.topCx+g.ux*g.halfW,by=g.topCy+g.uy*g.halfW;const cx=ax+g.nx*g.gh,cy=ay+g.ny*g.gh;const dx=bx+g.nx*g.gh,dy=by+g.ny*g.gh;octx.save();octx.strokeStyle='rgba(255,255,255,.5)';octx.setLineDash([4,4]);octx.beginPath();octx.moveTo(ax,ay);octx.lineTo(bx,by);octx.lineTo(dx,dy);octx.lineTo(cx,cy);octx.closePath();octx.stroke();octx.restore()}

function loop(){if(!running)return;anim=requestAnimationFrame(loop);draw();if(!detecting||!rimLine)return;wctx.drawImage(els.video,0,0,work.width,work.height);const curr=wctx.getImageData(0,0,work.width,work.height);if(!loop.prev){loop.prev=curr;return}const prev=loop.prev;let moved=0,sumX=0,sumY=0;for(let i=0;i<curr.data.length;i+=4){const dr=curr.data[i]-prev.data[i],dg=curr.data[i+1]-prev.data[i+1],db=curr.data[i+2]-prev.data[i+2];const diff=Math.abs(dr)+Math.abs(dg)+Math.abs(db);if(diff>THRESH){const idx=i/4,x=idx%work.width,y=(idx-x)/work.width;moved++;sumX+=x;sumY+=y;}}loop.prev=curr;if(moved>MIN_AREA&&moved<MAX_AREA){const cx=(sumX/moved)*(els.overlay.width/work.width),cy=(sumY/moved)*(els.overlay.height/work.height);octx.beginPath();octx.arc(cx,cy,8,0,Math.PI*2);octx.fillStyle='#45f0a0';octx.fill();const now=performance.now();history.push({t:now,y:cy});while(history.length&&now-history[0].t>800)history.shift();const first=history[0],recent=history[history.length-1];if(first&&recent&&recent.y-first.y>25){if(!loop.lastTrigger||now-loop.lastTrigger>1200){loop.lastTrigger=now;showToast();speak('Nice shot')}}}}

function startCalibration(){const points=[];function onTap(ev){ev.preventDefault();const {x,y}=pointerToCanvas(ev);points.push({x,y});showMagnifier(ev);if(points.length===2){els.overlay.removeEventListener('click',onTap);els.overlay.removeEventListener('touchstart',onTap);hideMagnifier();rimLine={x1:points[0].x,y1:points[0].y,x2:points[1].x,y2:points[1].y};draw();}}
els.overlay.addEventListener('click',onTap,{passive:false});els.overlay.addEventListener('touchstart',onTap,{passive:false});}

function pointerToCanvas(ev){const rect=els.overlay.getBoundingClientRect();const cx=ev.touches?ev.touches[0].clientX:ev.clientX;const cy=ev.touches?ev.touches[0].clientY:ev.clientY;return{x:(cx-rect.left)*(els.overlay.width/rect.width),y:(cy-rect.top)*(els.overlay.height/rect.height)}}

// Magnifier logic
const magCtx=els.magCanvas.getContext('2d');
function showMagnifier(ev){const rect=els.overlay.getBoundingClientRect();els.magnifier.style.display='block';const clientX=ev.touches?ev.touches[0].clientX:ev.clientX;const clientY=ev.touches?ev.touches[0].clientY:ev.clientY;els.magnifier.style.left=(clientX-60)+'px';els.magnifier.style.top=(clientY-60)+'px';magCtx.drawImage(els.video,clientX-30,clientY-30,60,60,0,0,120,120)}
function hideMagnifier(){els.magnifier.style.display='none'}

els.btnStart.addEventListener('click',startCam);
els.btnStop.addEventListener('click',stopAll);
els.btnCalib.addEventListener('click',startCalibration);
els.btnDetect.addEventListener('click',()=>{detecting=true});
els.btnEdit.addEventListener('click',()=>{editing=!editing});
</script>
</body>
</html>


